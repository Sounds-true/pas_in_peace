1) Короткое резюме сравнения

Что у вас уже сильно и соответствует лучшим практикам

Идея конечного автомата + стратифицированная логика: явные состояния (кризис/дисфункциональные/переходные/конструктивные), правила переходов, стратегии вмешательств — это современный «control‑plane» подход к LLM (state machine над генерацией).

Безопасность и протоколы кризиса: отдельные guardrails, детекция суицидальных/насильственных маркеров, сценарии эскалации.

Терапевтические техники: КПТ (реструктуризация), МИ/ННО (NVC), элементы IFS и пошаговые «маршруты» (ярость→ННО, шок→принятие).

Супервизор/монитор: «supervisor»‑слой для соответствия протоколу — основа для «двухагентной» архитектуры (генератор + ревизор).

Сценарная детализация: готовые диалоги/микро‑шаги, домашние задания, чек‑ины, фазы сопровождения.

Чего, на мой взгляд, не хватает / что можно усилить

Исполнимый сценарий как код (policy‑as‑code): формальное DSL/граф (например, LangGraph) и диалоговая политика (например, Rasa CALM FlowPolicy), чтобы матрица не была «описанием», а стала компилируемой логикой. 
LangChain Blog
+2
Medium
+2

Стратегия‑сначала (strategy‑first) генерация: сначала LLM выбирает терапевтическую стратегию/приём, затем генерирует реплику в её рамках (сокращает «галлюцинации» и повышает адгезию к КПТ/МИ). Для МИ такой alignment подтверждается недавними работами. 
arxiv.org
+1

Промышленные guardrails: использовать NeMo Guardrails/Colang для событийных правил (эскалация, блокировки тем, «жёсткие остановки»), плюс «среднерисковые» кейсы — отдельная логика (проблемная зона по результатам новых оценок). 
NVIDIA Docs
+1

Автодетекция когнитивных искажений с валидацией: подключить готовые пайплайны/классификаторы (Tauscher 2023 и др.) к вашему модулю identify_cognitive_distortions(). 
psychiatryonline.org

Память и аудит: чёткое разделение эпизодической памяти (по сессиям), профиля кейса (факты/цели/юридические события) и RAG (психообразование), с правилами хранения/удаления и реестром доступов.

Оценка эффективности: встроить план измерений (WAI/альянс, PHQ‑9, GAD‑7, PSI, поведенческие KPI) + протоколы «технической сертификации» бота (BOLT/VERA‑MH‑подобные фреймворки для авто‑оценки). 
arxiv.org
+1

Этика/регуляция: выверенный модуль информированного согласия, запреты на «медицинские/юридические советы», хранение ePHI и соответствие руководствам ВОЗ по LMM. 
World Health Organization
+1

2) Сопоставление ваш файл → исследование (точки совпадения)

«Терапия как конечный автомат» — ваш подход 1:1 совпадает с индустриальным кейсом LangChain/Sonia (КПТ‑сессия в 8 стадий; переходы управляются правилами + LLM‑проверками целей этапа). 
LangChain Blog

Гибрид «правила + LLM» — ваша архитектура слоёв (NLU→State Machine→Strategy→Safety→LLM→Supervisor) отражает современный стек: LangGraph для графа состояний и Rasa CALM (LLM→DSL→детерминированное исполнение). 
Medium
+1

Guardrails — у вас прописаны кризисные триггеры/протоколы; это хорошо лягает на Colang 2.0 (события/паттерны), где легко задать «паттерн: суицидальная лексика → жёсткая ветка CRISIS + блок генерации». 
NVIDIA Docs
+1

МИ/NVC/КПТ — ваша связка техник == текущим публикациям по выравниванию диалога с терапевтическими стратегиями (особенно для МИ). 
arxiv.org

Кризис‑ответы — у вас чёткие шаги оценки риска и эскалации; исследования отмечают, что именно здесь боты часто «проваливаются» в промежуточных рисках, поэтому ваш протокол — критически важный элемент. 
psychiatryonline.org

3) Что я бы добавил поверх вашего решения
3.1 Исполнимая архитектура (policy‑as‑code, безопасная оркестрация)

Высокоуровневая схема v2

User → Ingestion (PII scrub) 
     → NLU & Risk Gate (suicide/violence classifier; CD-detector) 
     → State Estimator (HMM/ensembles; features: эмоции/паттерны/факты) 
     → Policy Graph (LangGraph) 
         ├─ Strategy Selector (MI/CBT/NVC/IFS; "strategy-first") 
         ├─ Tool Router (retrieval, templates, schedulers)
     → Safety Rails (NeMo/Colang rules + middle-risk handler)
     → Response Generator (LLM) 
     → Supervisor (Referee agent; adherence + tone + legal/medical guardrail)
     → Memory Layer (episodic / profile / RAG)
     → Analytics & QA (BOLT/VERA-MH-like eval; audit log)


Граф состояний: описываем маршрут терапии как граф, узлы — клинические стадии/упражнения, рёбра — условия/гейты. (LangGraph — естественный выбор). 
Medium

CALM/FlowPolicy: перевод свободной фразы пользователя в DSL‑команду (intent→action) и детерминированное исполнение (Rasa). 
Rasa

Colang‑правила: события user_said, llm_output, tool_result, crisis_detected → паттерны → «жёсткие» ветки/блокировки. 
NVIDIA Docs

Strategy‑first prompting:

PREDICT_STRATEGY = {MI_reflection, CBT_dispute, NVC_request, IFS_parts, Psychoeducation,...}

GENERATE_REPLY с жёстким JSON‑каркасом: {strategy, targets, evidence, reply, next_check}. (См. данные по выравниванию диалога с МИ‑стратегиями.) 
arxiv.org

3.2 Безопасность (усиления)

Средний риск: отдельная политика (в исследованиях именно здесь непоследовательность; нужен «safety‑coach»: задаёт уточняющие вопросы, даёт ресурсы, ставит «контракт безопасности», план на 24 ч). 
psychiatryonline.org

Guardrails‑код (набросок Colang):
pattern: «упоминание плана/средств/срока» ⇒ halt_generation() ⇒ «скрипт CRISIS + номера + просьба подтвердить безопасность» ⇒ «лог + уведомление дежурному клиницисту (если доступен)». 
NVIDIA Docs

Регуляторика/этика: информированное согласие, указание «не мед/не юр консультация», управление данными по руководству ВОЗ LMM (прозрачность, пояснимость, non‑discrimination, постмаркетинговый надзор). 
World Health Organization
+1

3.3 Память и данные

Episodic Store (сессия→резюме→весомые факты), Profile Store (ребёнок/контакты/юридическая хронология/цели), RAG‑база (психопросвещение, NVC‑шаблоны), политики retention/шифрование/аудит.

PHI‑конвейер: PII‑scrubber до логирования, контроль доступа, экспорт отчётов по запросу пользователя.

3.4 Автодетекция когнитивных искажений

Встроить валидированные подходы к CD‑детекции (катастрофизация/персонализация/«долженствование» и т.п.) — это делает ваше identify_cognitive_distortions() доказательно‑обоснованным. 
psychiatryonline.org
+1

3.5 Оценка и валидация

Онлайн‑метрики: альянс (короткая WAI‑форма), самочувствие (1–10), конфликтность коммуникации (NVC‑чек‑лист), качество контакта с ребёнком, удержание/DAU.

Периодические шкалы: PHQ‑9/GAD‑7/PSI (с осторожными дисклеймерами).

Авто‑оценка безопасности: регулярные прогоны по чек‑листам BOLT/VERA‑MH‑типа (симулированные диалоги разных рисков; judge‑agent). 
arxiv.org
+1

4) «Моя» версия: архитектура, сценарий и матрица
4.1 Архитектура (исполняемая)

Слои и интерфейсы

NLU & Risk Gate

Sentiment/emotion, кризис‑классификатор, CD‑детектор, извлечение фактов.

Выход: {emotions, risk, facts, cd_tags}. 
psychiatryonline.org

State Estimator

Функция: estimate(user_ctx) → state_id, confidence.

Источники: признаки из NLU + история переходов + «флаги событий» (суд, контакт).

Policy Graph (LangGraph)

Узлы: SHOCK, RAGE, DESPAIR, GUILT, BARGAINING, OBSESSIVE, ACCEPTANCE, UNDERSTANDING, HEALING, STRATEGIC, NVC, PARALLEL_PARENTING, WAITING, GROWTH.

Рёбра: формализуем ваши «маршруты 1–5» + дополнительные (см. ниже). 
Medium

Strategy Selector (strategy‑first)

Кандидаты: CBT_dispute, MI_reflection, NVC_request, IFS_parts, Psychoeducation, Crisis_script, Action_planning.

Алгоритм: argmax P(strategy | state, goal, risk, cd_tags); стратегия → каркас ответа. 
arxiv.org

Safety Rails (NeMo/Colang)

Паттерны: суицид/насилие/вред ребёнку/юридические советы/диагностика/медикаменты/ minors.

Действия: block/redirect/escalate/log. 
NVIDIA Docs

LLM Generator

Вход: {strategy, targets, context, tone='warm-professional'}.

Выход строго по JSON‑схеме (валидируем Guardrails AI/JSON‑schema).

Supervisor (Referee agent)

Проверка: соответствие протоколу, проверка стиля (эмпатия/ННО), запреты (legal/medical).

Memory Layer

EpisodeSummary, CaseProfile, PsychoEduRAG, policy retention.

Analytics & QA

Онлайн‑дашборды: риск‑инциденты, альянс, прогресс, отклонения.

Реализация: граф — LangGraph, политика — Rasa CALM (FlowPolicy), guardrails — NeMo/Colang. 
Medium
+2
Rasa
+2

4.2 Сценарные «золотые пути» (добавления к вашим маршрутам)

У вас уже есть 1) Шок→Принятие, 2) Ярость→ННО, 3) Отчаяние→Самоисцеление, 4) Вина→Самопрощение, 5) Одержимая борьба→Стратегия. Я добавлю ещё два типичных:

Маршрут 6: Торг/манипуляции → Границы/реальность → Параллельное родительство

Фокус: снять «быстрые магические решения», перевести в границы + НВО + расписание контактов.

Инструменты: NVC‑шаблоны писем, матрица Эйзенхауэра для действий, «критерий решений: приближает к ребёнку?».

Маршрут 7: Принятие → Стратегическое планирование → Ожидание‑присутствие

Фокус: SMART‑цели на 1/6/24 мес, «присутствие без навязчивости», ритуалы качества времени и «дневник контактов» (для суда без эскалации).

4.3 Матрица состояний v2 (сжатая таблица)
Состояние	Цель узла	Входные индикаторы	Выбранные стратегии	Вход/Выход условия	KPI
SHOCK	Заземление, микро‑действие	онемение, «не верю», избегание фактов	Psychoeducation, GENTLE_REALITY_GROUNDING	Вход: шок‑лексика; Выход: ответы на 3 факт‑вопроса + 1 микро‑действие	завершённость микро‑шага; снижение confusion
RAGE	Разгрузка эмоций, ННО	демонизация, планы мести	EMOTIONAL_DISCHARGE_TO_NVC, MI_reflection	Выход: 1 NVC‑сообщение‑шаблон; отказ от угроз	снижение токсичности, рост NVC‑индекса
DESPAIR	Безопасность, надежда	«не хочу жить», «всё потеряно»	CRISIS_SCRIPT, MI_reflection	Вход: risk=critical→ hard stop; Выход: подтверждение безопасности	соблюдение протокола, follow‑up 24ч
GUILT	Реструктуризация убеждений	«всё моя вина», «я плохой родитель»	CBT_dispute, self‑compassion	Выход: список фактов/контекст/альтернативные мысли	снижение CD‑оценки
OBSESSIVE	Снижение эскалации	«только суд», сбор «доказательств»	Cost‑benefit, Strategic reframing	Выход: план паузы и приоритетов	сокращение конфликтных действий
ACCEPTANCE	План действий	рациональные установки	Action_planning, NVC	Выход: SMART‑план + недельный коммит	выполнение задач недели
NVC	Коммуникация	запрос тренинга	NVC_training	Выход: 1 письмо/сообщение по ННО	ответ‑rate контрагента
PARALLEL_PARENTING	Снижение контакта с экс‑партнёром	«война»	Boundaries, routines	Выход: «деловая» коммуникация, правила	инциденты‑конфликты ↓
WAITING	«Присутствие» без давления	нет ответа ребёнка	Presence, rituals	Выход: календарь мягких касаний	регулярность касаний
GROWTH	Трансценденция	готовность помогать другим	Meaning‑making	Выход: волонтёрство/группа	субъективное благополучие

(Содержимое согласовано с вашей исходной матрицей и сгруппировано по операционным полям.)

4.4 Примеры исполнимых фрагментов

(A) Colang‑паттерн для суицидального риска (NeMo Guardrails)

Идея: любое упоминание плана/средств → аварийная ветка CRISIS с жёсткой остановкой генерации.

NVIDIA Docs

define flow crisis_detection
  when user.says any_of("покончу с собой", "не хочу жить", "убью себя", "лучше умереть")
    do set(risk, "CRITICAL")
    do halt_generation()
    do goto("CRISIS_PROTOCOL")
end


(B) Strategy‑first JSON (вход → выход генератора)

{
  "strategy": "CBT_dispute",
  "targets": ["персонализация", "катастрофизация"],
  "evidence_from_user": ["...цитата..."],
  "reply": "Я вижу, как вам больно... Давайте проверим факты... ",
  "next_check": "ask_for_alt_thought"
}


(Такой формат затем валидируется и логируется для аудита/оценки соответствия технике.)

(C) CALM/FlowPolicy идея (Rasa): LLM → action: nvc_template_request → исполнительный блок формирует письмо по ННО и журналирует. 
Rasa

4.5 Алгоритм оценки состояния (добавления)

Фичи: эмоции (valence/arousal), кризис‑тэги, CD‑тэги, факт‑слоты (давность контакта, тактики «алиенатора», судебные шаги), «сигналы прогресса».

Инференс: ансамбль правил + лёгкий классификатор (логистическая регрессия/GBM) с байесовским сглаживанием по истории переходов.

Ветвление по риску: CRITICAL → CRISIS, HIGH → уточняющие вопросы + ресурсы, LOW → обычный поток.
(Ваш псевдокод легко расширяется такими функциями.) 
psychiatryonline.org

4.6 Оценка и мониторинг (операционализация)

Альянс/эмпатия: короткий WAI‑опрос раз в 2 недели; автоматическая MI‑адгезия (если выбран MI_reflection). 
arxiv.org

Симптомы: PHQ‑9/GAD‑7 (не как диагноз!); PSI для родительского стресса.

Безопасность: еженедельные прогоны автотестов по кризисным сценариям (включая «средний риск») и аудит логов. 
psychiatryonline.org

Этика/ВОЗ: трекинг прозрачности (какая стратегия применена и почему), «право на объяснение», экспорт/удаление данных. 
World Health Organization

5) Что именно дополнить в вашем текущем документе (быстрые победы)

Раздел «Исполнимый DSL»: добавить YAML/Colang‑описания узлов/переходов/правил (чтобы матрица → код). 
NVIDIA Docs

Strategy‑first prompt: вставить в «Алгоритм выбора стратегии» шаг predict_strategy() и JSON‑схему ответа.

Средний риск: отдельный протокол и чек‑лист (уточняющие вопросы, ресурсы, контракт безопасности). 
psychiatryonline.org

CD‑модуль: ссылка на валидированные методики и «словарь» искажений, примеры триггерных фраз. 
psychiatryonline.org

Память: спецификацию трёх хранилищ (эпизоды/профиль/RAG) и политику retention.

Reg/этика: блок «Согласие и дисклеймеры», «обработка minors», «не мед/не юр советы», ссылка на руководство ВОЗ LMM. 
World Health Organization

QA/оценка: список метрик, расписание опросников, авто‑эвалюатор (BOLT/VERA‑MH‑подобный). 
arxiv.org
+1

6) Готовый «мини‑шаблон» моего варианта (можно вставлять в репозиторий)

policy/graph.yaml (фрагмент)

states:
  - id: SHOCK
    entry: [psychoeducation.brief, grounding.micro_action]
    exit_criteria:
      - answered_facts >= 3
      - micro_action_done == true
    transitions:
      - to: UNDERSTANDING
        if: user.requests_info or time_in_state > 2
      - to: RAGE
        if: emotions.anger > 0.6
  - id: RAGE
    entry: [venting.safe_space, reflection.mi, nvc.intro]
    exit_criteria: [nvc.template_ready == true]
    transitions:
      - to: NVC
        if: nvc.template_ready
      - to: DESPAIR
        if: emotions.sadness > 0.7 and hopelessness == true
  # ...


rails/crisis.colang (фрагмент)

define flow suicide_medium_risk
  when user.says any_of("больше не могу", "нет смысла жить")
    if not user_mentions(plan or means)
      do set(risk, "MEDIUM")
      do goto("CRISIS_CHECKUP")
end


NVIDIA Docs

strategies/selector.py (псевдокод)

def predict_strategy(state, risk, cd_tags):
    if risk == "CRITICAL": return "CRISIS_SCRIPT"
    if state=="GUILT" and "personalization" in cd_tags: return "CBT_dispute"
    if state=="RAGE": return "MI_reflection_then_NVC"
    # ...


schemas/reply.json

{
  "type": "object",
  "required": ["strategy", "reply", "next_check"],
  "properties": {
    "strategy": {"enum": ["CBT_dispute","MI_reflection","NVC_request","IFS_parts","Psychoeducation","Crisis_script","Action_planning"]},
    "reply": {"type": "string", "maxLength": 1200},
    "next_check": {"type": "string"},
    "evidence_from_user": {"type": "array", "items":{"type":"string"}}
  }
}


memory/profile.json (ключи)

{"child":{"age":null},"contact":{"last_seen":null,"frequency":null},"legal":{"events":[]},
 "goals":{"1m":[],"6m":[],"24m":[]},"risk":{"last":null},"alliance":{"wai_short":[]}}

7) Итог

Ваш документ уже фактически содержит правильный каркас терапевтической системы с контролем поведения LLM — состояния, переходы, протоколы, стратегии и примеры диалогов. Мой основной вклад — сделать это исполняемым и проверяемым: превратить матрицу в граф‑как‑код (LangGraph/CALM), добавить strategy‑first слой, промышленные guardrails (Colang) с отдельной логикой для «среднего риска», ввести автодетекцию когнитивных искажений, формализовать память, и закрепить оценку/этику по руководствам ВОЗ. Так мы получим детерминируемый, проверяемый и безопасный AI‑помощник для отчуждаемых родителей. 
World Health Organization
+4
LangChain Blog
+4
Medium
+4

Использованные внешние источники (ключевые)

Терапия как конечный автомат (КПТ, Sonia/LangChain) — описание 8‑стадийной сессии и state‑machine подхода. 
LangChain Blog

LangGraph / граф‑состояний для агентов — stateful workflows. 
Medium

Rasa CALM (LLM→DSL→детерминированное исполнение) — блоги/релизы 2024. 
Rasa
+1

NeMo Guardrails / Colang 2.0 — событийные паттерны и программируемые guardrails. 
NVIDIA Docs
+1

Валидация/оценка LLM‑терапевтов, МИ‑выравнивание — BOLT/МИ‑alignment. 
arxiv.org
+1

Безопасность суицидального риска — непоследовательность ответов ИИ на промежуточный риск. 
psychiatryonline.org

Автодетекция когнитивных искажений — NLP‑исследования (Tauscher 2023; Positive Reconstruction 2024). 
psychiatryonline.org
+1

Этика/регулирование ВОЗ для LMM — рекомендации 2024/2025. 
World Health Organization
.