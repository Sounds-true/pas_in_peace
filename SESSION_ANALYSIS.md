# –ê–Ω–∞–ª–∏–∑ –°–µ—Å—Å–∏–∏ —Å PAS Bot

## –î–∞—Ç–∞: 08.11.2025

## –ß—Ç–æ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–∞–∑–µ –î–∞–Ω–Ω—ã—Ö

### –î–∞–Ω–Ω—ã–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user_id: 430658962):
```sql
telegram_id:     430658962
current_state:   START
therapy_phase:   UNDERSTANDING
total_messages:  0          # ‚ö†Ô∏è –ù–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ~10+)
emotional_score: 0.6        # 0-1, –≥–¥–µ 1 = —Ö–æ—Ä–æ—à–æ
crisis_level:    0.1        # 0-1, –≥–¥–µ 1 = –∫—Ä–∏–∑–∏—Å
last_activity:   2025-11-08 10:53:38
```

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –î–∞–Ω–Ω—ã—Ö:

**emotional_score: 0.6**
- –°—Ä–µ–¥–Ω–∏–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
- –ù–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π, –Ω–æ –µ—Å—Ç—å –¥–∏—Å—Ç—Ä–µ—Å—Å
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏ –æ—Ç—á—É–∂–¥–µ–Ω–∏—è

**crisis_level: 0.1**
- –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∫—Ä–∏–∑–∏—Å–∞
- –ù–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π —É–≥—Ä–æ–∑—ã
- –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ü–µ–Ω–∏–ª–∞, —á—Ç–æ –Ω–µ –Ω—É–∂–Ω–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å

**current_state: START**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç–∞–¥–∏–∏ –¥–∏–∞–ª–æ–≥–∞
- –°–∏—Å—Ç–µ–º–∞ –µ—â—ë —Å–æ–±–∏—Ä–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

**therapy_phase: UNDERSTANDING**
- –§–∞–∑–∞ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏
- –ë–æ—Ç —Å–æ–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –¥–µ—Ç–∞–ª–∏

---

## –ü—É—Ç—å –ß–µ—Ä–µ–∑ State Graph (–†–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)

### –ü–æ—Ç–æ–∫ –û–±—Ä–∞–±–æ—Ç–∫–∏:

```
1. /start
   ‚Üì
   START state
   ‚Üì
   –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

2. "–ú–Ω–µ —Ç—è–∂–µ–ª–æ"
   ‚Üì
   process_message()
   ‚Üì
   emotion_check ‚Üí –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —ç–º–æ—Ü–∏—è (keyword: "—Ç—è–∂–µ–ª–æ")
   ‚Üì
   –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∏—Å—Ç—Ä–µ—Å—Å–∞: LOW (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –Ω–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∫—Ä–∏–∑–∏—Å)
   ‚Üì
   Route: casual_chat (–Ω–∏–∑–∫–∏–π –¥–∏—Å—Ç—Ä–µ—Å—Å)
   ‚Üì
   technique_selection
   ‚Üì
   TechniqueOrchestrator ‚Üí Active Listening
   ‚Üì
   OpenAI GPT-4 –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç

3. "3 –≥–æ–¥–∞ –Ω–µ –≤–∏–¥–µ–ª —Å—ã–Ω–∞"
   ‚Üì
   process_message()
   ‚Üì
   emotion_check ‚Üí —Ç–µ–º—ã: missing_child, –æ–±—â–∏–π –¥–∏—Å—Ç—Ä–µ—Å—Å
   ‚Üì
   Route: moderate_support (—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–∑–ª—É–∫–∏)
   ‚Üì
   technique_selection
   ‚Üì
   Active Listening —Å context:
      - message_count: 2
      - stage: "–Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ - –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–ª—É—à–∞–Ω–∏–µ"
      - message_history: ["–ú–Ω–µ —Ç—è–∂–µ–ª–æ", "3 –≥–æ–¥–∞ –Ω–µ –≤–∏–¥–µ–ª —Å—ã–Ω–∞"]
   ‚Üì
   OpenAI –ø–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é ‚Üí —É–ø–æ–º–∏–Ω–∞–µ—Ç "—Å—ã–Ω–∞" –≤ –æ—Ç–≤–µ—Ç–µ

4-N. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   ‚Üì
   –° –∫–∞–∂–¥—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:
   - message_count —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è
   - message_history –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è
   - stage –º–µ–Ω—è–µ—Ç—Å—è (1-2 ‚Üí 3-5 ‚Üí 6+)
   - context –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Å user_state –≤ OpenAI
```

---

## –ú–æ–¥—É–ª–∏: –ß—Ç–æ –†–∞–±–æ—Ç–∞–µ—Ç vs –ß—Ç–æ –û—Ç–∫–ª—é—á–µ–Ω–æ

### ‚úÖ –†–ê–ë–û–¢–ê–ï–¢:

#### 1. **Core Bot** (`src/core/bot.py`)
- ‚úÖ Telegram polling
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (/start, /help, /letter, /goals, /crisis)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ Logging –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π

#### 2. **State Manager** (`src/orchestration/state_manager.py`)
- ‚úÖ LangGraph state machine
- ‚úÖ UserState management (–≤ –ø–∞–º—è—Ç–∏)
- ‚úÖ message_history —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- ‚úÖ Routing –ø–æ —É—Ä–æ–≤–Ω—é –¥–∏—Å—Ç—Ä–µ—Å—Å–∞
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ context —Å user_state –≤ —Ç–µ—Ö–Ω–∏–∫–∏

#### 3. **Emotion Detection** (keyword-based)
- ‚úÖ –ë–∞–∑–æ–≤–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- ‚úÖ –¢–µ–º—ã: contact_denied, child_refuses, missing_child, guilt, etc.
- ‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —ç–º–æ—Ü–∏–π: grief, anger, sadness, fear

#### 4. **Technique Orchestrator** (`src/techniques/orchestrator.py`)
- ‚úÖ –í—ã–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ç–µ—Ö–Ω–∏–∫ (Active Listening –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤)
- ‚úÖ Fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

#### 5. **Active Listening** (`src/techniques/active_listening.py`)
- ‚úÖ OpenAI GPT-4 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ conversation history (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
- ‚úÖ Stage-based system prompts
- ‚úÖ Anti-repetition measures (temperature=0.8, penalties)

#### 6. **Supervisor Agent** (`src/techniques/supervisor_agent.py`)
- ‚úÖ Quality control –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ empathy, safety, boundaries
- ‚úÖ Red flags detection
- ‚úÖ Approve/reject –ª–æ–≥–∏–∫–∞

#### 7. **Database** (PostgreSQL)
- ‚úÖ Users table (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π)
- ‚úÖ emotional_score, crisis_level tracking
- ‚úÖ Sessions tracking
- ‚ö†Ô∏è –ù–û: message_history –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

#### 8. **Crisis Detection** (keyword-based)
- ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã—Ö –º—ã—Å–ª–µ–π
- ‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–≥—Ä–æ–∑ –Ω–∞—Å–∏–ª–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ crisis state
- ‚úÖ Hotline –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

---

### ‚ùå –û–¢–ö–õ–Æ–ß–ï–ù–û (Temporarily Disabled):

#### 1. **Guardrails** (`src/guardrails/`)
- ‚ùå Disabled: "initialization issues"
- –ü—Ä–∏—á–∏–Ω–∞: –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –º–æ–¥–µ–ª–µ–π
- –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

#### 2. **Emotion Detector (ML-based)** (`src/nlp/emotion_detector.py`)
- ‚ùå Disabled: "initialization hang"
- –ü—Ä–∏—á–∏–Ω–∞: –ó–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ML –º–æ–¥–µ–ª–∏
- Fallback: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è keyword-based –¥–µ—Ç–µ–∫—Ü–∏—è

#### 3. **Knowledge Retriever** (`src/knowledge/retriever.py`)
- ‚ùå Disabled: "initialization hang"
- –ü—Ä–∏—á–∏–Ω–∞: –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î –∏–ª–∏ embeddings
- –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ù–µ—Ç RAG (Retrieval-Augmented Generation)

#### 4. **Entity Extractor** (`src/nlp/entity_extractor.py`)
- ‚ùå Disabled: "initialization hang"
- –ü—Ä–∏—á–∏–Ω–∞: –ó–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ NER –º–æ–¥–µ–ª–∏
- –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–º—ë–Ω, –¥–∞—Ç, etc.

#### 5. **Intent Classifier** (`src/nlp/intent_classifier.py`)
- ‚ùå Disabled: "initialization hang"
- –ü—Ä–∏—á–∏–Ω–∞: –ó–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏
- Fallback: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è keyword matching

#### 6. **Speech Handler** (`src/nlp/speech_handler.py`)
- ‚ùå Disabled: "temporarily disabled"
- –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è

#### 7. **PII Protector** (`src/nlp/pii_protector.py`)
- ‚ùå Disabled: "model loading hang"
- –ü—Ä–∏—á–∏–Ω–∞: –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π presidio –º–æ–¥–µ–ª–∏
- –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## –ö–∞–∫ –°–∏—Å—Ç–µ–º–∞ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –í–∞—à –î–∏–∞–ª–æ–≥

### –≠—Ç–∞–ø 1: –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –û—Ü–µ–Ω–∫–∞ (Keyword-Based)

**–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**: "3 –≥–æ–¥–∞ –Ω–µ –≤–∏–¥–µ–ª —Å—ã–Ω–∞"

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–µ–º—ã**:
```python
themes = [
    "missing_child",      # keywords: "–Ω–µ –≤–∏–¥–µ–ª"
    "general_distress"    # default
]

emotion = "grief"  # inferred from "–Ω–µ –≤–∏–¥–µ–ª —Å—ã–Ω–∞"
distress_level = "moderate"
```

### –≠—Ç–∞–ø 2: Routing –ø–æ State Graph

```python
emotional_intensity = 0.5  # moderate
risk_level = "low"         # crisis_level: 0.1

# Route decision:
if distress_level == "moderate":
    next_state = "moderate_support"
```

### –≠—Ç–∞–ø 3: –í—ã–±–æ—Ä –¢–µ—Ö–Ω–∏–∫–∏

```python
# TechniqueOrchestrator
emotional_state = EmotionalState.DESPAIR  # grief + moderate distress

# Priority techniques –¥–ª—è DESPAIR:
priority = [
    ActiveListening,
    CBTReframing,
    Grounding
]

selected = ActiveListening  # –í—Å–µ–≥–¥–∞ –ø–µ—Ä–≤—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
```

### –≠—Ç–∞–ø 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –û—Ç–≤–µ—Ç–∞ (OpenAI)

```python
# Context –ø–µ—Ä–µ–¥–∞–Ω –≤ Active Listening:
context = {
    "emotion": "grief",
    "emotion_intensity": 0.5,
    "language": "russian",
    "message_count": 2,
    "user_state": user_state,  # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û - —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è!
    "risk_level": "low"
}

# user_state —Å–æ–¥–µ—Ä–∂–∏—Ç:
user_state.message_history = [
    HumanMessage("–ú–Ω–µ —Ç—è–∂–µ–ª–æ"),
    AIMessage("–ü–æ–Ω–∏–º–∞—é... –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?"),
    HumanMessage("3 –≥–æ–¥–∞ –Ω–µ –≤–∏–¥–µ–ª —Å—ã–Ω–∞")
]

# OpenAI –ø–æ–ª—É—á–∞–µ—Ç:
messages = [
    {"role": "system", "content": system_prompt_with_stage},
    {"role": "user", "content": "–ú–Ω–µ —Ç—è–∂–µ–ª–æ"},
    {"role": "assistant", "content": "–ü–æ–Ω–∏–º–∞—é..."},
    {"role": "user", "content": "3 –≥–æ–¥–∞ –Ω–µ –≤–∏–¥–µ–ª —Å—ã–Ω–∞"}
]

# GPT-4 –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å —É—á—ë—Ç–æ–º –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏
```

### –≠—Ç–∞–ø 5: Quality Control (Supervisor)

```python
# SupervisorAgent –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç:
empathy_score = 0.7       # 2+ empathy indicators
safety_score = 1.0        # No red flags
overall_score = 0.8       # –•–æ—Ä–æ—à–∏–π –æ—Ç–≤–µ—Ç

approved = True  # ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

---

## –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –î–∏–∞–ª–æ–≥–∞ (Stage-Based)

### –°—Ç–∞–¥–∏–∏:

**–°–æ–æ–±—â–µ–Ω–∏—è 1-2** (ACTIVE LISTENING):
```
System Prompt: "–Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ - –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–ª—É—à–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è"

–ü–æ–≤–µ–¥–µ–Ω–∏–µ:
- –û—Ç—Ä–∞–∑–∏—Ç–µ —á—É–≤—Å—Ç–≤–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
- –û–¥–∏–Ω –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è
- –ë–ï–ó —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ "—è –∑–¥–µ—Å—å —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å"
```

**–°–æ–æ–±—â–µ–Ω–∏—è 3-5** (UNDERSTANDING):
```
System Prompt: "–ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ - —Å–±–æ—Ä –¥–µ—Ç–∞–ª–µ–π"

–ü–æ–≤–µ–¥–µ–Ω–∏–µ:
- –°—É–º–º–∏—Ä—É–π—Ç–µ —É—Å–ª—ã—à–∞–Ω–Ω–æ–µ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
- –£—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ —Å–∏—Ç—É–∞—Ü–∏–∏
- –ù–∞—á–Ω–∏—Ç–µ –≤–∏–¥–µ—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã
```

**–°–æ–æ–±—â–µ–Ω–∏—è 6+** (ACTION):
```
System Prompt: "–ø–µ—Ä–µ—Ö–æ–¥ –∫ –¥–µ–π—Å—Ç–≤–∏—è–º - –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –ø–∏—Å—å–º–æ –∏–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"

–ü–æ–≤–µ–¥–µ–Ω–∏–µ:
- –ö—Ä–∞—Ç–∫–æ —Ä–µ–∑—é–º–∏—Ä—É–π—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥:
  * "–í–æ–∑–º–æ–∂–Ω–æ, –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –Ω–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ –≤–∞—à–µ–º—É —Å—ã–Ω—É?"
  * "–•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç—Ç–∏–º–∏ —á—É–≤—Å—Ç–≤–∞–º–∏?"
```

---

## –ß—Ç–æ –î–∞–ª—å—à–µ?

### üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ó–∞–¥–∞—á–∏:

#### 1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å total_messages Counter**
**–ü—Ä–æ–±–ª–µ–º–∞**: –°—á—ë—Ç—á–∏–∫ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î (–≤—Å–µ–≥–¥–∞ 0)

**–ì–¥–µ –∏—Å–∫–∞—Ç—å**:
- `state_manager.py:407` - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è `user_state.messages_count`
- `state_manager.py:558` - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `save_user_state()`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `messages_count` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `messages_count` –≤ UPDATE –∑–∞–ø—Ä–æ—Å

#### 2. **–°–æ–∑–¥–∞—Ç—å –¢–∞–±–ª–∏—Ü—É Messages**
**–ó–∞—á–µ–º**: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏

```sql
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    role VARCHAR(20),  -- 'human' –∏–ª–∏ 'ai'
    content TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    technique_used VARCHAR(50),
    emotion VARCHAR(50),
    stage VARCHAR(50),  -- 'listening', 'understanding', 'action'
    metadata JSON
);

CREATE INDEX idx_messages_user_created ON messages(user_id, created_at);
```

**–ì–¥–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å**:
- `state_manager.py:543` - –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ `message_history`
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å HumanMessage –∏ AIMessage –≤ –ë–î

#### 3. **–í–∫–ª—é—á–∏—Ç—å –û—Ç–∫–ª—é—á—ë–Ω–Ω—ã–µ –ú–æ–¥—É–ª–∏ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

**PII Protector**:
- –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ presidio
- –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å simple regex-based –¥–µ—Ç–µ–∫—Ü–∏—é –≤–º–µ—Å—Ç–æ ML

**Entity Extractor**:
- –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ spaCy –º–æ–¥–µ–ª–∏
- –†–µ—à–µ–Ω–∏–µ: Lazy loading –∏–ª–∏ –ø—Ä–æ—Å—Ç—ã–µ regex –ø—Ä–∞–≤–∏–ª–∞

**Emotion Detector**:
- –ü—Ä–æ–±–ª–µ–º–∞: ML –º–æ–¥–µ–ª—å –∑–∞–≤–∏—Å–∞–µ—Ç
- –†–µ—à–µ–Ω–∏–µ: –°–µ–π—á–∞—Å keyword-based —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å

---

### üü° –£–ª—É—á—à–µ–Ω–∏—è (–°—Ä–µ–¥–Ω–∏–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç):

#### 1. **Letter Writing Flow**
**–°–µ–π—á–∞—Å**: –ö–æ–º–∞–Ω–¥–∞ `/letter` –ø—Ä–æ—Å—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ö–æ–º—É —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å?"

**–£–ª—É—á—à–∏—Ç—å**:
- –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É `LetterWritingAssistant`
- Multi-turn dialogue –¥–ª—è —Å–±–æ—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –ø–∏—Å—å–º–∞
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è

#### 2. **Goal Tracking**
**–°–µ–π—á–∞—Å**: –¢–∞–±–ª–∏—Ü–∞ `goals` –ø—É—Å—Ç–∞—è

**–î–æ–±–∞–≤–∏—Ç—å**:
- –ü–æ—Å–ª–µ 3-5 —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ü–µ–ª—å
- "–ß–µ–≥–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –¥–æ—Å—Ç–∏—á—å –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å —Å—ã–Ω–æ–º?"
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å

#### 3. **–ú–µ—Ç—Ä–∏–∫–∏ –∏ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞**
- –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –¥–∏–∞–ª–æ–≥–∞
- –ß–∞—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫
- Conversion rate (—Å–∫–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ ‚Üí –Ω–∞–ø–∏—Å–∞–ª–∏ –ø–∏—Å—å–º–æ)

---

### üü¢ –ë—É–¥—É—â–∏–µ –§–∏—á–∏ (–ù–∏–∑–∫–∏–π –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç):

1. **A/B Testing** —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –ø—Ä–æ–º–ø—Ç–æ–≤
2. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
3. **–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å** (—Å–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π)
4. **–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** (–∫–æ–≥–¥–∞ –≤–∫–ª—é—á–∏–º speech_handler)
5. **RAG** —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –æ PA

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å `/start`**
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–∞–º—è—Ç—å**:
   - –£–ø–æ–º—è–Ω–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∏–º—è —Ä–µ–±—ë–Ω–∫–∞
   - –ß–µ—Ä–µ–∑ 3-4 —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –ø–æ–º–Ω–∏—Ç –∏–º—è
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é**:
   - –ù–∞–ø–∏—à–∏—Ç–µ 6+ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ –∏–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ `/letter`**:
   - –î–æ–ª–∂–µ–Ω –Ω–∞—á–∞—Ç—å—Å—è –¥–∏–∞–ª–æ–≥ –æ –ø–∏—Å—å–º–µ
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î –ø–æ—Å–ª–µ –¥–∏–∞–ª–æ–≥–∞**:
   ```sql
   SELECT * FROM users WHERE telegram_id = 430658962;
   ```

### –î–ª—è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç #1**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `messages_count` –≤ –ë–î
2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç #2**: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `messages` –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é
3. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç #3**: –£–ª—É—á—à–∏—Ç—å letter writing flow
4. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç #4**: –î–æ–±–∞–≤–∏—Ç—å goal tracking

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ó–∞–º–µ—Ç–∫–∏

### –ß—Ç–æ –†–∞–±–æ—Ç–∞–µ—Ç –•–æ—Ä–æ—à–æ:

‚úÖ **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: –ö–∞–∂–¥–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å
‚úÖ **Supervisor**: –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –æ—Ç–≤–µ—Ç–æ–≤
‚úÖ **Stage-based progression**: –õ–æ–≥–∏—á–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç —Å–ª—É—à–∞–Ω–∏—è –∫ –¥–µ–π—Å—Ç–≤–∏—è–º
‚úÖ **OpenAI integration**: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

### –ß—Ç–æ –ú–æ–∂–Ω–æ –£–ª—É—á—à–∏—Ç—å:

‚ö†Ô∏è **Persistence**: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
‚ö†Ô∏è **ML Models**: –í—Å–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã –∏–∑-–∑–∞ –∑–∞–≤–∏—Å–∞–Ω–∏–π
‚ö†Ô∏è **Metrics**: –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚ö†Ô∏è **Error Handling**: –ù–µ—Ç graceful degradation –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ OpenAI

---

## –õ–æ–≥–∏ –¥–ª—è –û—Ç–ª–∞–¥–∫–∏

### –ö–ª—é—á–µ–≤—ã–µ Events:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è
grep "process_message_started" bot.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫–∏
grep "technique_orchestrated" bot.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é LLM
grep "llm_response_generated" bot.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å supervision
grep "supervision_complete" bot.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
grep "save_user_state" bot.log
```

### SQL Queries –¥–ª—è –ü—Ä–æ–≤–µ—Ä–∫–∏:

```sql
-- –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT * FROM users
WHERE telegram_id = '430658962'
ORDER BY last_activity DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT
    telegram_id,
    total_messages,
    emotional_score,
    crisis_level,
    therapy_phase,
    DATE_TRUNC('minute', last_activity) as last_seen
FROM users
WHERE telegram_id = '430658962';

-- (–ë—É–¥—É—â–µ–µ) –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
SELECT
    role,
    content,
    technique_used,
    created_at
FROM messages
WHERE user_id = (SELECT id FROM users WHERE telegram_id = '430658962')
ORDER BY created_at;
```
