# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–î–∞—Ç–∞:** 2025-11-06
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

---

## üéØ –ì–ª–∞–≤–Ω—ã–π –í—ã–≤–æ–¥

**–°–ø—Ä–∏–Ω—Ç—ã 1-3 —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç–ª–∏—á–Ω–æ (Safety, Therapeutic, Quality) ‚úÖ**
**–°–ø—Ä–∏–Ω—Ç 5 –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ (Testing, Metrics) ‚úÖ**
**–°–ø—Ä–∏–Ω—Ç 4 –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç (Legal Tools) üî¥**

**–û–±—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: 79% (395/500)**

---

## ‚úÖ –ß—Ç–æ –†–∞–±–æ—Ç–∞–µ—Ç (–°–ø—Ä–∏–Ω—Ç—ã 1-3, 5)

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚úÖ
- **bot.py** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç PII –∏ –∫—Ä–∏–∑–∏—Å—ã –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- **StateManager** –ø—Ä–∏–º–µ–Ω—è–µ—Ç guardrails –≤–Ω—É—Ç—Ä–∏
- **CrisisDetector** –ª–æ–≤–∏—Ç —Å—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏
- **PIIProtector** –∑–∞—â–∏—â–∞–µ—Ç –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### 2. –¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ ‚úÖ
- **TechniqueOrchestrator** –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–µ—Ö–Ω–∏–∫—É
- **5 —Ç–µ—Ö–Ω–∏–∫** —Ä–∞–±–æ—Ç–∞—é—Ç: CBT, Grounding, IFS, MI, Active Listening
- **SupervisorAgent** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤

### 3. NLP –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ‚úÖ
- **EmotionDetector** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç–º–æ—Ü–∏–∏
- **IntentClassifier** –ø–æ–Ω–∏–º–∞–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏—è
- **EntityExtractor** –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏

### 4. –ú–µ—Ç—Ä–∏–∫–∏ ‚úÖ (–ù–û–í–û–ï)
- **MetricsCollector** –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ StateManager
- –°–æ–±–∏—Ä–∞–µ—Ç: response time, errors, guardrails, messages

### 5. –¢–µ—Å—Ç—ã ‚úÖ (–ù–û–í–û–ï)
- **21 —Å—Ü–µ–Ω–∞—Ä–∏–π** –¥–ª—è 7 —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
- **30+ adversarial prompts** –¥–ª—è red-team testing
- **bot_adapter** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ü—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ #1: Syntax Error –≤ Legal Tools ‚õî

**–§–∞–π–ª:** `src/legal/legal_tools_handler.py:208`

```python
response_text += "\n".join(dos_donts['DON'T'])  # ‚ùå –û–®–ò–ë–ö–ê
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–µ—Å—å –º–æ–¥—É–ª—å Legal Tools –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è!

**–†–µ—à–µ–Ω–∏–µ:** (5 –º–∏–Ω—É—Ç)
```python
response_text += "\n".join(dos_donts["DON'T"])  # ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–∞–≤—ã—á–∫–∏
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: Legal Tools –ù–µ –ü–æ–¥–∫–ª—é—á–µ–Ω—ã ‚õî

**–°–∏—Ç—É–∞—Ü–∏—è:**
- ‚úÖ Legal tools —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã (ContactDiary, BIFF, Mediation, Parenting Model)
- ‚úÖ IntentClassifier —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç legal intents
- ‚ùå StateManager –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LegalToolsHandler
- ‚ùå –ù–ï–¢ routing –¥–ª—è legal intents

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å legal tools!

**–†–µ—à–µ–Ω–∏–µ:** (30-45 –º–∏–Ω—É—Ç)
```python
# –í StateManager.__init__
from src.legal import LegalToolsHandler
self.legal_tools = LegalToolsHandler()

# –í process_message –¥–æ–±–∞–≤–∏—Ç—å routing
if intent in [CONTACT_DIARY, BIFF_HELP, ...]:
    return await self.legal_tools.handle_intent(...)
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö –ù–µ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚õî

**–°–∏—Ç—É–∞—Ü–∏—è:**
- ‚úÖ Database models –≥–æ—Ç–æ–≤—ã (User, Session, Message)
- ‚úÖ –°—Ö–µ–º–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å UserState
- ‚ùå StateManager –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç database
- ‚ùå –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è!

**–†–µ—à–µ–Ω–∏–µ:** (2-3 —á–∞—Å–∞)
```python
# –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Database –≤ StateManager
class StateManager:
    async def initialize(self):
        self.db = Database()
        await self.db.initialize()

    async def get_user_state(self, user_id):
        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ë–î –µ—Å–ª–∏ –Ω–µ—Ç –≤ –∫–µ—à–µ
        user_data = await self.db.get_user(user_id)
        # ...

    async def save_user_state(self, user_state):
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
        await self.db.save_user(user_state)
```

---

## üü° –°—Ä–µ–¥–Ω–∏–µ –ü—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ #4: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:**
- `langgraph` - –Ω—É–∂–µ–Ω –¥–ª—è StateManager
- `sqlalchemy` - –Ω—É–∂–µ–Ω –¥–ª—è database
- `structlog` - —É–∂–µ –µ—Å—Ç—å –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```bash
pip install -r requirements.txt
```

---

## üìä –¢–∞–±–ª–∏—Ü–∞ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –°–ø—Ä–∏–Ω—Ç | –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|--------|-------------|------------|--------|
| 1 (Safety) | 100% | 100% | ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ |
| 2 (Therapeutic) | 100% | 100% | ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ |
| 3 (Quality) | 100% | 100% | ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ |
| 4 (Legal) | 100% | **0%** | üî¥ –ù–ï –†–ê–ë–û–¢–ê–ï–¢ |
| 5 (Testing+Metrics) | 100% | 95% | ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ |

---

## üéØ –ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π

### –°–µ–π—á–∞—Å (1 —á–∞—Å):
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å syntax error (5 –º–∏–Ω)
2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å LegalToolsHandler (45 –º–∏–Ω)
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å legal tools (10 –º–∏–Ω)

### –ë–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è (2-3 —á–∞—Å–∞):
4. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
5. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å database persistence
6. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π flow —Å –ë–î

---

## üí≠ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç A: –ë—ã—Å—Ç—Ä—ã–µ Fixes (1 —á–∞—Å)
**–ò—Å–ø—Ä–∞–≤–∏–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã #1 –∏ #2:**
- Fix syntax error
- Integrate legal tools
- Test

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–ø—Ä–∏–Ω—Ç—ã 1-5 —Ä–∞–±–æ—Ç–∞—é—Ç, –∫—Ä–æ–º–µ persistence

---

### –í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–ª–Ω—ã–µ Fixes (3-4 —á–∞—Å–∞)
**–ò—Å–ø—Ä–∞–≤–∏–º –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã #1, #2, #3:**
- Fix syntax error
- Integrate legal tools
- Integrate database
- Test full flow

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 100% working, production ready

---

### –í–∞—Ä–∏–∞–Ω—Ç C: –°–æ–∑–¥–∞—Ç—å PR –°–µ–π—á–∞—Å
**–°–æ–∑–¥–∞—Ç—å PR –¥–ª—è Sprint 5 –∫–∞–∫ –µ—Å—Ç—å:**
- –°–ø—Ä–∏–Ω—Ç 5 (Testing + Metrics) —Ä–∞–±–æ—Ç–∞–µ—Ç
- –í –æ–ø–∏—Å–∞–Ω–∏–∏ PR —É–∫–∞–∑–∞—Ç—å known issues (#1, #2, #3)
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–º PR

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Sprint 5 –≤ main, fixes –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏

---

## ü§î –ú–æ–π –°–æ–≤–µ—Ç

–Ø —Ä–µ–∫–æ–º–µ–Ω–¥—É—é **–í–∞—Ä–∏–∞–Ω—Ç A (–±—ã—Å—Ç—Ä—ã–µ fixes, 1 —á–∞—Å)**:

**–ü–æ—á–µ–º—É:**
1. Legal tools —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã - –∂–∞–ª–∫–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
2. Syntax error —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–π - 5 –º–∏–Ω—É—Ç
3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è legal tools –ø—Ä–æ—Å—Ç–∞—è - 45 –º–∏–Ω—É—Ç
4. Database persistence –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ

**–ü–æ—Å–ª–µ –í–∞—Ä–∏–∞–Ω—Ç–∞ A:**
- –°–ø—Ä–∏–Ω—Ç—ã 1-5 –≤—Å–µ —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ
- Legal tools –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º ‚úÖ
- –¢–æ–ª—å–∫–æ persistence –æ—Å—Ç–∞—ë—Ç—Å—è (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç MVP)
- –ú–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å PR –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ persistence

---

## üìù –ß—Ç–æ –í—ã–±–µ—Ä–µ—Ç–µ?

```
A - –ë—ã—Å—Ç—Ä—ã–µ fixes (1 —á–∞—Å) - legal tools + syntax fix [–†–ï–ö–û–ú–ï–ù–î–£–Æ]
B - –ü–æ–ª–Ω—ã–µ fixes (3-4 —á–∞—Å–∞) - –≤—Å–µ + database
C - PR —Å–µ–π—á–∞—Å - Sprint 5 as-is, fixes –ø–æ—Ç–æ–º
```

---

**–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!** ‚úÖ
**–ñ–¥—ë–º –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ** üéØ
